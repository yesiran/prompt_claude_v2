{% extends "base.html" %}

{% block styles %}
<!-- é€šç”¨æ ·å¼ -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<!-- å­é¡µé¢ç‰¹å®šæ ·å¼ -->
{% block page_styles %}{% endblock %}
{% endblock %}

{% block content %}
<div class="app-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="app-header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <span class="app-logo">Prompt the World</span>
        </div>
        
        <div class="header-center">
            <input type="search" 
                   class="search-bar" 
                   id="searchBar"
                   placeholder="æœç´¢...">
        </div>
        
        <div class="header-right">
            <button class="setting-btn" id="settingBtn">âš™</button>
            <div class="user-avatar" id="userAvatar">
                <span id="userInitial">U</span>
            </div>
        </div>
    </header>
    
    <!-- ä¾§è¾¹æ  -->
    <aside class="app-sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <a href="/home" class="nav-item" data-page="prompts">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-text">æˆ‘çš„Prompt</span>
            </a>
            <a href="#" class="nav-item" data-page="collaboration">
                <span class="nav-icon">ğŸ‘¥</span>
                <span class="nav-text">åä½œç©ºé—´</span>
            </a>
            <a href="/tags" class="nav-item" data-page="tags">
                <span class="nav-icon">ğŸ·ï¸</span>
                <span class="nav-text">æ ‡ç­¾ç®¡ç†</span>
            </a>
            <a href="#" class="nav-item" data-page="history">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">æµ‹è¯•å†å²</span>
            </a>
        </nav>
        
        <!-- æ ‡ç­¾è¿‡æ»¤ -->
        <div class="tag-filter">
            <h3 class="filter-title">æ ‡ç­¾ç­›é€‰</h3>
            <div class="tag-list" id="tagFilter">
                <span class="tag-item active" data-tag="">å…¨éƒ¨</span>
                <!-- åŠ¨æ€åŠ è½½æ ‡ç­¾ -->
            </div>
        </div>
        
        <!-- ç™»å‡ºæŒ‰é’® -->
        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
        </div>
    </aside>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="app-main">
        {% block page_content %}{% endblock %}
    </main>
</div>

<!-- å¼•å…¥è®¤è¯å·¥å…· -->
<script src="{{ url_for('static', filename='js/auth.js') }}"></script>

<script>
// å…¨å±€å¯¼èˆªè„šæœ¬
document.addEventListener('DOMContentLoaded', () => {
    // ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯æ£€æŸ¥
    if (window.AuthUtils && !window.AuthUtils.initAuthCheck()) {
        return; // è®¤è¯å¤±è´¥ï¼Œå·²é‡å®šå‘
    }
    
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('userInitial').textContent = user.username ? user.username[0].toUpperCase() : 'U';
    
    // ç»‘å®šé€šç”¨äº‹ä»¶
    bindLayoutEvents();
    
    // è®¾ç½®å½“å‰é¡µé¢çš„å¯¼èˆªæ¿€æ´»çŠ¶æ€
    setActiveNav();
    
    // è°ƒç”¨é¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–å‡½æ•°
    if (typeof initPage === 'function') {
        initPage();
    }
});

// ç»‘å®šå¸ƒå±€äº‹ä»¶
function bindLayoutEvents() {
    // èœå•åˆ‡æ¢
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('collapsed');
    });
    
    // ç™»å‡º
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        await fetch('/api/v1/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
    });
    
    // æœç´¢æ äº‹ä»¶ï¼ˆå¯ä»¥è¢«é¡µé¢è¦†ç›–ï¼‰
    if (typeof handleSearch === 'function') {
        let searchTimer;
        document.getElementById('searchBar').addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                handleSearch(e.target.value);
            }, 300);
        });
    }
}

// è®¾ç½®å½“å‰é¡µé¢çš„å¯¼èˆªæ¿€æ´»çŠ¶æ€
function setActiveNav() {
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        item.classList.remove('active');
        
        // æ ¹æ®è·¯å¾„åˆ¤æ–­æ¿€æ´»çŠ¶æ€
        if (currentPath === '/home' && item.dataset.page === 'prompts') {
            item.classList.add('active');
        } else if (currentPath.startsWith('/editor') && item.dataset.page === 'prompts') {
            item.classList.add('active');
        } else if (currentPath.includes(item.dataset.page)) {
            item.classList.add('active');
        }
    });
}

// æ ¼å¼åŒ–æ—¥æœŸï¼ˆé€šç”¨å·¥å…·å‡½æ•°ï¼‰
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 7) {
        return date.toLocaleDateString('zh-CN');
    } else if (days > 0) {
        return `${days}å¤©å‰`;
    } else if (hours > 0) {
        return `${hours}å°æ—¶å‰`;
    } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿå‰`;
    } else {
        return 'åˆšåˆš';
    }
}
</script>

<!-- é¡µé¢ç‰¹å®šè„šæœ¬ -->
{% block page_scripts %}{% endblock %}
{% endblock %}