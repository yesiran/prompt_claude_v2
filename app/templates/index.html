{% extends "layout.html" %}

{% block title %}æˆ‘çš„Prompt - Prompt the World{% endblock %}

{% block page_content %}
<div class="content-header">
    <h2 class="content-title">æˆ‘çš„Prompt</h2>
    <div class="content-actions">
        <select class="sort-select" id="sortSelect">
            <option value="created_at">åˆ›å»ºæ—¶é—´</option>
            <option value="updated_at">æ›´æ–°æ—¶é—´</option>
            <option value="star_count">æ”¶è—æ•°</option>
        </select>
    </div>
</div>

<div class="prompt-grid" id="promptGrid">
    <!-- æ–°å»ºå¡ç‰‡ -->
    <div class="prompt-card new-card" id="newPromptCard">
        <div class="new-card-content">
            <span class="new-icon">+</span>
            <span class="new-text">åˆ›å»ºæ–°Prompt</span>
        </div>
    </div>
    
    <!-- åŠ¨æ€åŠ è½½Promptå¡ç‰‡ -->
</div>

<!-- åˆ†é¡µ -->
<div class="pagination" id="pagination">
    <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µæŒ‰é’® -->
</div>
{% endblock %}

{% block page_scripts %}
<script>
// é¡µé¢åˆå§‹åŒ–å‡½æ•°ï¼ˆä¼šè¢«layout.htmlè°ƒç”¨ï¼‰
function initPage() {
    // åŠ è½½Promptåˆ—è¡¨
    loadPrompts();
    
    // åŠ è½½æ ‡ç­¾
    loadTags();
    
    // ç»‘å®šé¡µé¢ç‰¹å®šäº‹ä»¶
    bindPageEvents();
}

// å¤„ç†æœç´¢ï¼ˆä¼šè¢«layout.htmlè°ƒç”¨ï¼‰
function handleSearch(searchText) {
    loadPrompts(1, searchText);
}

// åŠ è½½Promptåˆ—è¡¨
async function loadPrompts(page = 1, search = '', tags = '') {
    try {
        const token = localStorage.getItem('token');
        const sort = document.getElementById('sortSelect').value;
        
        const params = new URLSearchParams({
            page,
            limit: 12,
            search,
            tags,
            sort,
            order: 'desc'
        });
        
        const response = await fetch(`/api/v1/prompts?${params}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            renderPrompts(data.data.items);
            renderPagination(data.data.pagination);
        }
    } catch (error) {
        console.error('åŠ è½½Promptå¤±è´¥:', error);
    }
}

// æ¸²æŸ“Promptå¡ç‰‡
function renderPrompts(prompts) {
    const grid = document.getElementById('promptGrid');
    
    // ä¿ç•™æ–°å»ºå¡ç‰‡
    const newCard = document.getElementById('newPromptCard');
    grid.innerHTML = '';
    grid.appendChild(newCard);
    
    // æ·»åŠ Promptå¡ç‰‡
    prompts.forEach(prompt => {
        const card = createPromptCard(prompt);
        grid.appendChild(card);
    });
}

// åˆ›å»ºPromptå¡ç‰‡
function createPromptCard(prompt) {
    const card = document.createElement('div');
    card.className = 'prompt-card';
    card.dataset.id = prompt.id;
    
    const preview = prompt.content.substring(0, 100) + (prompt.content.length > 100 ? '...' : '');
    
    card.innerHTML = `
        <div class="card-header">
            <h3 class="card-title">${prompt.title}</h3>
            <span class="card-version">v${prompt.version_count}</span>
        </div>
        <p class="card-preview">${preview}</p>
        <div class="card-tags">
            ${prompt.tags ? prompt.tags.map(tag => 
                `<span class="tag" style="background-color: ${tag.color}20; color: ${tag.color}">${tag.name}</span>`
            ).join('') : ''}
        </div>
        <div class="card-footer">
            <span class="card-date">${formatDate(prompt.updated_at)}</span>
            <span class="card-stats">
                <span>ğŸ‘ ${prompt.stats.view_count}</span>
                <span>ğŸ§ª ${prompt.stats.test_count}</span>
            </span>
        </div>
    `;
    
    card.addEventListener('click', () => {
        window.location.href = `/editor/${prompt.id}`;
    });
    
    return card;
}

// åŠ è½½æ ‡ç­¾
async function loadTags() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/v1/tags', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            renderTagFilter(data.data);
        }
    } catch (error) {
        console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
    }
}

// æ¸²æŸ“æ ‡ç­¾è¿‡æ»¤å™¨
function renderTagFilter(tags) {
    const tagFilter = document.getElementById('tagFilter');
    
    // ä¿ç•™"å…¨éƒ¨"é€‰é¡¹
    const allOption = tagFilter.querySelector('[data-tag=""]');
    tagFilter.innerHTML = '';
    tagFilter.appendChild(allOption);
    
    // æ·»åŠ æ ‡ç­¾
    tags.forEach(tag => {
        const tagItem = document.createElement('span');
        tagItem.className = 'tag-item';
        tagItem.dataset.tag = tag.id;
        tagItem.textContent = tag.name;
        tagItem.style.borderColor = tag.color;
        
        tagItem.addEventListener('click', () => {
            // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tag-item').forEach(t => t.classList.remove('active'));
            tagItem.classList.add('active');
            
            // é‡æ–°åŠ è½½Prompt
            const search = document.getElementById('searchBar').value;
            loadPrompts(1, search, tag.id);
        });
        
        tagFilter.appendChild(tagItem);
    });
}

// æ¸²æŸ“åˆ†é¡µ
function renderPagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    paginationEl.innerHTML = '';
    
    if (pagination.pages <= 1) return;
    
    // ä¸Šä¸€é¡µ
    if (pagination.page > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.textContent = 'ä¸Šä¸€é¡µ';
        prevBtn.onclick = () => loadPrompts(pagination.page - 1);
        paginationEl.appendChild(prevBtn);
    }
    
    // é¡µç 
    for (let i = 1; i <= pagination.pages; i++) {
        if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === pagination.page ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => loadPrompts(i);
            paginationEl.appendChild(pageBtn);
        } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            const dots = document.createElement('span');
            dots.className = 'page-dots';
            dots.textContent = '...';
            paginationEl.appendChild(dots);
        }
    }
    
    // ä¸‹ä¸€é¡µ
    if (pagination.page < pagination.pages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
        nextBtn.onclick = () => loadPrompts(pagination.page + 1);
        paginationEl.appendChild(nextBtn);
    }
}

// ç»‘å®šé¡µé¢ç‰¹å®šäº‹ä»¶
function bindPageEvents() {
    // æ–°å»ºPrompt
    document.getElementById('newPromptCard').addEventListener('click', () => {
        window.location.href = '/editor/new';
    });
    
    // æ’åº
    document.getElementById('sortSelect').addEventListener('change', () => {
        const search = document.getElementById('searchBar').value;
        loadPrompts(1, search);
    });
    
    // æ ‡ç­¾è¿‡æ»¤å™¨çš„"å…¨éƒ¨"é€‰é¡¹
    document.querySelector('[data-tag=""]').addEventListener('click', () => {
        document.querySelectorAll('.tag-item').forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tag=""]').classList.add('active');
        const search = document.getElementById('searchBar').value;
        loadPrompts(1, search);
    });
}
</script>
{% endblock %}