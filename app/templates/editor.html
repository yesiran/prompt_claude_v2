{% extends "layout.html" %}

{% block title %}编辑器 - Prompt the World{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/elegant.min.css">
{% endblock %}

{% block page_content %}
<div class="editor-container">
    <!-- 编辑器头部 -->
    <header class="editor-header">
        <div class="header-left">
            <button class="back-btn" id="backBtn" title="返回列表">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <input type="text" 
                   class="title-input" 
                   id="titleInput"
                   placeholder="无标题Prompt"
                   maxlength="200">
        </div>
        
        <div class="header-center">
            <span class="save-status" id="saveStatus">
                <span class="status-dot"></span>
                <span class="status-text">已保存</span>
            </span>
            <span class="version-info" id="versionInfo">版本 1</span>
        </div>
        
        <div class="header-right">
            <button class="save-btn" id="saveBtn" title="保存 (Cmd+S)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                保存
            </button>
            <button class="icon-btn" id="focusBtn" title="专注模式 (Cmd+/)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <circle cx="12" cy="12" r="10"/>
                </svg>
            </button>
            <button class="icon-btn" id="historyBtn" title="历史版本 (Cmd+H)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
            </button>
            <button class="icon-btn" id="shareBtn" title="协作分享">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </button>
            <button class="primary-btn" id="testBtn" title="测试运行 (Cmd+Enter)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                测试运行
            </button>
        </div>
    </header>
    
    <!-- 编辑器主体 -->
    <div class="editor-body">
        <!-- 标签栏 -->
        <div class="tag-bar">
            <div class="selected-tags" id="selectedTags">
                <!-- 动态加载已选标签 -->
            </div>
            <button class="add-tag-btn" id="addTagBtn">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                添加标签
            </button>
        </div>
        
        <!-- 描述区域 -->
        <div class="description-area">
            <input type="text" 
                   class="description-input" 
                   id="descriptionInput"
                   placeholder="添加描述，帮助你和协作者理解这个Prompt的用途（可选）"
                   maxlength="500">
        </div>
        
        <!-- 编辑区域 -->
        <div class="editor-wrapper">
            <div class="editor-toolbar">
                <div class="toolbar-left">
                    <span class="word-count" id="wordCount">0 字</span>
                    <span class="char-count" id="charCount">0 字符</span>
                </div>
                <div class="toolbar-right">
                    <button class="toolbar-btn" id="markdownBtn" title="Markdown预览">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                    </button>
                </div>
            </div>
            <textarea id="promptEditor" class="editor-textarea"></textarea>
        </div>
    </div>
    
    <!-- 焦点模式遮罩 -->
    <div class="focus-overlay" id="focusOverlay"></div>
</div>

<!-- 测试面板 -->
<div class="test-panel" id="testPanel">
    <div class="panel-header">
        <h3>测试Prompt</h3>
        <button class="panel-close" id="closePanelBtn">×</button>
    </div>
    
    <div class="panel-body">
        <!-- 模型选择 -->
        <div class="form-group">
            <label class="form-label">选择模型</label>
            <div class="model-select">
                <label class="radio-label">
                    <input type="radio" name="model" value="gpt-5" checked>
                    <span class="radio-text">GPT-5</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="model" value="claude-opus-4.1">
                    <span class="radio-text">Claude Opus 4.1</span>
                </label>
            </div>
        </div>
        
        <!-- 参数设置 -->
        <div class="form-group">
            <label class="form-label">Temperature</label>
            <input type="range" 
                   id="temperatureSlider" 
                   min="0" 
                   max="1" 
                   step="0.1" 
                   value="0.7"
                   class="slider">
            <span class="slider-value" id="temperatureValue">0.7</span>
        </div>
        
        <!-- 测试输入 -->
        <div class="form-group">
            <label class="form-label">测试输入（可选）</label>
            <textarea class="test-input" 
                      id="testInput" 
                      placeholder="输入测试内容，如果留空将只测试Prompt本身"
                      rows="4"></textarea>
        </div>
        
        <!-- 运行按钮 -->
        <button class="run-test-btn" id="runTestBtn">
            <span class="btn-text">运行测试</span>
            <span class="loading-spinner" style="display: none;"></span>
        </button>
        
        <!-- 测试结果 -->
        <div class="test-result" id="testResult" style="display: none;">
            <div class="result-header">
                <span class="result-model" id="resultModel">GPT-5</span>
                <span class="result-stats">
                    <span class="result-time" id="resultTime">1.2s</span>
                    <span class="result-tokens" id="resultTokens">150 tokens</span>
                </span>
            </div>
            <div class="result-content" id="resultContent">
                <!-- 测试结果内容 -->
            </div>
            <button class="copy-result-btn" id="copyResultBtn">复制结果</button>
        </div>
    </div>
</div>

<!-- 版本历史面板 -->
<div class="history-panel" id="historyPanel">
    <div class="panel-header">
        <h3>版本历史</h3>
        <button class="panel-close" id="closeHistoryBtn">×</button>
    </div>
    
    <div class="panel-body">
        <div class="version-list" id="versionList">
            <!-- 动态加载版本列表 -->
        </div>
    </div>
</div>

<!-- 标签选择器 -->
<div class="tag-selector" id="tagSelector" style="display: none;">
    <div class="selector-header">
        <h4>选择标签</h4>
        <button class="selector-close" id="closeTagSelector">×</button>
    </div>
    <div class="selector-body">
        <div class="tag-categories">
            <div class="tag-category">
                <h5>场景</h5>
                <div class="tag-options" id="sceneTags">
                    <!-- 动态加载 -->
                </div>
            </div>
            <div class="tag-category">
                <h5>模型</h5>
                <div class="tag-options" id="modelTags">
                    <!-- 动态加载 -->
                </div>
            </div>
            <div class="tag-category">
                <h5>类型</h5>
                <div class="tag-options" id="typeTags">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block page_scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>

<!-- 编辑器主逻辑 -->
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
{% endblock %}